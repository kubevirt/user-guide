<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Installation & Administration | Node eviciton</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://kubevirt.io/"><img alt="Kubevirt" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../administration/intro.html">Installation & Administration</a>
      </li>
      
      <li class="hidden-xs active">
        Node eviciton
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-down"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse in list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class=" active" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
            <li><a class="" href="../administration/live-migration.html">Live Migration</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/virtio-win.html">virtio drivers for Microsoft Windows</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
            <li><a class="" href="../creating-virtual-machines/run-strategies.html">Run Strategies</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup7">
        <span id="tgSpan7" class="fa fa-angle-right"></span>Web Interface
      </a>
      <ul id="topicGroup7" class="collapse  list-unstyled">
            <li><a class="" href="../web-interface/web-interface.html">Web Interface</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>VirtualMachineInstance Node Eviction</h2>
        </div>
        <div class="sect1">
<h2 id="virtualmachineinstance-node-eviction"><a class="anchor" href="#virtualmachineinstance-node-eviction"></a>VirtualMachineInstance Node Eviction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before removing a kubernetes node from the cluster, users will want to
ensure that VirtualMachineInstances have been gracefully terminated
before powering down the node. Since all VirtualMachineInstances are
backed by a Pod, the recommended method of evicting
VirtualMachineInstances is to use the <strong>kubectl drain</strong> command, or in the
case of OKD the <strong>oc adm drain</strong> command.</p>
</div>
<div class="sect2">
<h3 id="how-to-evict-all-vms-on-a-node"><a class="anchor" href="#how-to-evict-all-vms-on-a-node"></a>How to Evict all VMs on a Node</h3>
<div class="paragraph">
<p>Select the node you’d like to evict VirtualMachineInstances from by
identifying the node from the list of cluster nodes.</p>
</div>
<div class="paragraph">
<p><code>kubectl get nodes</code></p>
</div>
<div class="paragraph">
<p>The following command will gracefully terminate all VMs on a specific
node. Replace ** with the target node you want the eviction to occur on.</p>
</div>
<div class="paragraph">
<p><code>kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets=true --force --pod-selector=kubevirt.io=virt-launcher</code></p>
</div>
<div class="paragraph">
<p>Below is a break down of why each argument passed to the drain command
is required.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubectl drain &lt;node name&gt;</code> is selecting a specific node as a target
for the eviction</p>
</li>
<li>
<p><code>--delete-local-data</code> is a required flag that is necessary for
removing any pod that utilizes an emptyDir volume. The
VirtualMachineInstance Pod does use emptryDir volumes, however the data
in those volumes are ephemeral which means it is safe to delete after
termination.</p>
</li>
<li>
<p><code>--ignore-daemonsets=true</code> is a required flag because every node
running a VirtualMachineInstance will also be running our helper
DaemonSet called virt-handler. DaemonSets are not allowed to be evicted
using <strong>kubectl drain</strong>. By default, if this command encounters a
DaemonSet on the target node, the command will fail. This flag tells the
command it is safe to proceed with the eviction and to just ignore
DaemonSets.</p>
</li>
<li>
<p><code>--force</code> is a required flag because VirtualMachineInstance pods are
not owned by a ReplicaSet or DaemonSet controller. This means kubectl
can’t guarantee that the pods being terminated on the target node will
get re-scheduled replacements placed else where in the cluster after the
pods are evicted. KubeVirt has its own controllers which manage the
underlying VirtualMachineInstance pods. Each controller behaves
differently to a VirtualMachineInstance being evicted. That behavior is
outlined futher down in this document.</p>
</li>
<li>
<p><code>--pod-selector=kubevirt.io=virt-launcher</code> means only
VirtualMachineInstance pods managed by KubeVirt will be removed from the
node.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="how-to-evict-all-vms-and-pods-on-a-node"><a class="anchor" href="#how-to-evict-all-vms-and-pods-on-a-node"></a>How to Evict all VMs and Pods on a Node</h3>
<div class="paragraph">
<p>By removing the <strong>–pod-selector</strong> argument from the previous command, we
can issue the eviction of all Pods on a node. This command ensures Pods
associated with VMs as well as all other Pods are evicted from the
target node.</p>
</div>
<div class="paragraph">
<p><code>kubectl drain &lt;node name&gt; --delete-local-data --ignore-daemonsets=true --force</code></p>
</div>
</div>
<div class="sect2">
<h3 id="how-to-evacuate-vmis-via-live-migration-from-a-node"><a class="anchor" href="#how-to-evacuate-vmis-via-live-migration-from-a-node"></a>How to evacuate VMIs via Live Migration from a Node</h3>
<div class="paragraph">
<p>If the <strong>LiveMigration</strong> feature gate is enabled, it is possible to specify an
<code>evictionStrategy</code> on VMIs which will react with live-migrations on specific
taints on nodes. The following snipped on a VMI ensures that the VMI is migrated
if the <code>kubevirt.io/drain:NoSchedule</code> taint is added to a nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">spec</span>:
  <span style="color:#606">evictionStrategy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">LiveMigrate</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here a full VMI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha3</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">testvmi-nocloud</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">terminationGracePeriodSeconds</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">30</span></span>
  <span style="color:#606">evictionStrategy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">LiveMigrate</span></span>
  <span style="color:#606">domain</span>:
    <span style="color:#606">resources</span>:
      <span style="color:#606">requests</span>:
        <span style="color:#606">memory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">1024M</span></span>
    <span style="color:#606">devices</span>:
      <span style="color:#606">disks</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: containerdisk</span></span>
        <span style="color:#606">disk</span>:
          <span style="color:#606">bus</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">virtio</span></span>
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">disk:</span><span style="color:#D20">
          bus: virtio</span></span>
        <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">cloudinitdisk</span></span>
  <span style="color:#606">volumes</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: containerdisk</span></span>
    <span style="color:#606">containerDisk</span>:
      <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt/fedora-cloud-container-disk-demo:latest</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: cloudinitdisk</span></span>
    <span style="color:#606">cloudInitNoCloud</span>:
      <span style="color:#606">userData</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|-</span><span style="color:#D20">
        #cloud-config
        password: fedora
        chpasswd: { expire: False }</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the VMI is created, taint the node with</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl taint nodes foo kubevirt.io/drain=draining:NoSchedule</pre>
</div>
</div>
<div class="paragraph">
<p>which will trigger a migration.</p>
</div>
<div class="paragraph">
<p>Behind the scenes a <strong>PodDisruptionBudget</strong> is created for each VMI which has an
<strong>evictionStrategy</strong> defined. This ensures that evictions are be blocked on these
VMIs and that we can guarantee that a VMI will be migrated instead of shut off.</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> While the <strong>evictionStrategy</strong> blocks the shutdown of VMIs during
evictions, the live migration process is detached from the drain process
itselve. Therefore it is necessary to add specified taints as part of the drain
process explicitly, until we have a better integrated solution.</p>
</div>
<div class="paragraph">
<p>By default KubeVirt will rewact with live migrations if the taint
<code>kubevirt.io/drain:NoSchedule</code> is added to the node. It is possible to
configure a different key in the <code>kubevirt-config</code> config map, by setting in
the migration options the <code>nodeDrainTaintKey</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ConfigMap</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt-config</span></span>
  <span style="color:#606">namespace</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt</span></span>
  <span style="color:#606">labels</span>:
    <span style="color:#606">kubevirt.io</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">data</span>:
  <span style="color:#606">feature-gates</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">LiveMigration</span><span style="color:#710">&quot;</span></span>
  <span style="color:#606">migrations</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">|-</span><span style="color:#D20">
    nodeDrainTaintKey: mytaint/drain</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The default value is <code>kubevirt.io/drain</code>. With the change above migrations can
be triggered with</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl taint nodes foo mytaint/drain=draining:NoSchedule</pre>
</div>
</div>
<div class="paragraph">
<p>Here a full drain flow for nodes which includes VMI live migrations with the
default setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl taint nodes foo kubevirt.io/drain=draining:NoSchedule
kubectl drain foo --delete-local-data --ignore-daemonsets=true --force</pre>
</div>
</div>
<div class="paragraph">
<p>To make  the node schedulable again, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kubectl taint nodes foo kubevirt.io/drain-
kubectl uncordon foo</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="re-enabling-a-node-after-eviction"><a class="anchor" href="#re-enabling-a-node-after-eviction"></a>Re-enabling a Node after Eviction</h3>
<div class="paragraph">
<p>The <strong>kubectl drain</strong> will result in the target node being marked as
unschedulable. This means the node will not be eligible for running new
VirtualMachineInstances or Pods.</p>
</div>
<div class="paragraph">
<p>If it is decided that the target node should become schedulable again,
the following command must be run.</p>
</div>
<div class="paragraph">
<p><code>kubectl uncordon &lt;node name&gt;</code></p>
</div>
<div class="paragraph">
<p>or in the case of OKD.</p>
</div>
<div class="paragraph">
<p><code>oc adm uncordon &lt;node name&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="shutting-down-a-node-after-eviction"><a class="anchor" href="#shutting-down-a-node-after-eviction"></a>Shutting down a Node after Eviction</h3>
<div class="paragraph">
<p>From KubeVirt’s perspective, a node is safe to shutdown once all
VirtualMachineInstances have been evicted from the node. In a multi-use
cluster where VirtualMachineInstances are being scheduled along side
other containerized workloads, it is up to the cluster admin to ensure
all other pods have been safely evicted before powering down the node.</p>
</div>
</div>
<div class="sect2">
<h3 id="virtualmachine-evictions"><a class="anchor" href="#virtualmachine-evictions"></a>VirtualMachine Evictions</h3>
<div class="paragraph">
<p>The eviction of any VirtualMachineInstance that is owned by a
VirtualMachine set to <strong>running=true</strong> will result in the
VirtualMachineInstance being re-scheduled to another node.</p>
</div>
<div class="paragraph">
<p>The VirtualMachineInstance in this case will be forced to power down and
restart on another node. In the future once KubeVirt introduces live
migration support, the VM will be able to seamlessly migrate to another
node during eviction.</p>
</div>
</div>
<div class="sect2">
<h3 id="virtualmachineinstancereplicaset-eviction-behavior"><a class="anchor" href="#virtualmachineinstancereplicaset-eviction-behavior"></a>VirtualMachineInstanceReplicaSet Eviction Behavior</h3>
<div class="paragraph">
<p>The eviction of VirtualMachineInstances owned by a
VirtualMachineInstanceReplicaSet will result in the
VirtualMachineInstanceReplicaSet scheduling replacements for the evicted
VirtualMachineInstances on other nodes in the cluster.</p>
</div>
</div>
<div class="sect2">
<h3 id="virtualmachineinstance-eviction-behavior"><a class="anchor" href="#virtualmachineinstance-eviction-behavior"></a>VirtualMachineInstance Eviction Behavior</h3>
<div class="paragraph">
<p>VirtualMachineInstances not backed by either a
VirtualMachineInstanceReplicaSet or an VirtualMachine object will not be
re-scheduled after eviction.</p>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>
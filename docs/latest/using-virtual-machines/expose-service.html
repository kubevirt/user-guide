<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Using Virtual Machines | Service Integration</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://kubevirt.io/"><img alt="Kubevirt" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../using-virtual-machines/usage.html">Using Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        Service Integration
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
            <li><a class="" href="../administration/live-migration.html">Live Migration</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/virtio-win.html">virtio drivers for Microsoft Windows</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
            <li><a class="" href="../creating-virtual-machines/run-strategies.html">Run Strategies</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-down"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse in list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class=" active" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup7">
        <span id="tgSpan7" class="fa fa-angle-right"></span>Web Interface
      </a>
      <ul id="topicGroup7" class="collapse  list-unstyled">
            <li><a class="" href="../web-interface/web-interface.html">Web Interface</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Expose VirtualMachineInstances as a Services</h2>
        </div>
        <div class="sect1">
<h2 id="expose-virtualmachineinstances-as-a-services"><a class="anchor" href="#expose-virtualmachineinstances-as-a-services"></a>Expose VirtualMachineInstances as a Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the VirtualMachineInstance is started, in order to connect to a
VirtualMachineInstance, you can create a <code>Service</code> object for a
VirtualMachineInstance. Currently, three types of service are supported:
<code>ClusterIP</code>, <code>NodePort</code> and <code>LoadBalancer</code>. The default type is
<code>ClusterIP</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note</strong>: Labels on a VirtualMachineInstance are passed through to the
pod, so simply add your labels for service creation to the
VirtualMachineInstance. From there on it works like exposing any other
k8s resource, by referencing these labels in a service.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="expose-virtualmachineinstance-as-a-clusterip-service"><a class="anchor" href="#expose-virtualmachineinstance-as-a-clusterip-service"></a>Expose VirtualMachineInstance as a ClusterIP Service</h3>
<div class="paragraph">
<p>Give a VirtualMachineInstance with the label <code>special: key</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha3</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmi-ephemeral</span></span>
  <span style="color:#606">labels</span>:
    <span style="color:#606">special</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">disks</span>:
      - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">disk:</span><span style="color:#D20">
          bus: virtio</span></span>
        <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">containerdisk</span></span>
    <span style="color:#606">resources</span>:
      <span style="color:#606">requests</span>:
        <span style="color:#606">memory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">64M</span></span>
  <span style="color:#606">volumes</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: containerdisk</span></span>
    <span style="color:#606">containerDisk</span>:
      <span style="color:#606">image</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt/cirros-registry-disk-demo:latest</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>we can expose its SSH port (22) by creating a <code>ClusterIP</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Service</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">vmiservice</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">ports</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">port: 27017</span></span>
    <span style="color:#606">protocol</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">TCP</span></span>
    <span style="color:#606">targetPort</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">22</span></span>
  <span style="color:#606">selector</span>:
    <span style="color:#606">special</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key</span></span>
  <span style="color:#606">type</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ClusterIP</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You just need to create this <code>ClusterIP</code> service by using <code>kubectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl create -f vmiservice.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the VirtualMachineInstance could be exposed using the
<code>virtctl</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ virtctl expose virtualmachineinstance vmi-ephemeral --name vmiservice --port 27017 --target-port 22</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes: * If <code>--target-port</code> is not set, it will be take the same value
as <code>--port</code> * The cluster IP is usually allocated automatically, but it
may also be forced into a value using the <code>--cluster-ip</code> flag (assuming
value is in the valid range and not taken)</p>
</div>
<div class="paragraph">
<p>Query the service object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get service
NAME        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE
vmiservice   ClusterIP   172.30.3.149   &lt;none&gt;        27017/TCP   2m</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can connect to the VirtualMachineInstance by service IP and service
port inside the cluster network:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ssh cirros@172.30.3.149 -p 27017</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expose-virtualmachineinstance-as-a-nodeport-service"><a class="anchor" href="#expose-virtualmachineinstance-as-a-nodeport-service"></a>Expose VirtualMachineInstance as a NodePort Service</h3>
<div class="paragraph">
<p>Expose the SSH port (22) of a VirtualMachineInstance running on KubeVirt
by creating a <code>NodePort</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Service</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">nodeport</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">externalTrafficPolicy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Cluster</span></span>
  <span style="color:#606">ports</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: nodeport</span></span>
    <span style="color:#606">nodePort</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">30000</span></span>
    <span style="color:#606">port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">27017</span></span>
    <span style="color:#606">protocol</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">TCP</span></span>
    <span style="color:#606">targetPort</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">22</span></span>
  <span style="color:#606">selector</span>:
    <span style="color:#606">special</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key</span></span>
  <span style="color:#606">type</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">NodePort</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You just need to create this <code>NodePort</code> service by using <code>kubectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl -f nodeport.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the VirtualMachineInstance could be exposed using the
<code>virtctl</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ virtctl expose virtualmachineinstance vmi-ephemeral --name nodeport --type NodePort --port 27017 --target-port 22 --node-port 30000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notes: * If <code>--node-port</code> is not set, its value will be allocated
dynamically (in the range above 30000) * If the <code>--node-port</code> value is
set, it must be unique across all services</p>
</div>
<div class="paragraph">
<p>The service can be listed by querying for the service objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get service
NAME           TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)           AGE
nodeport       NodePort   172.30.232.73   &lt;none&gt;        27017:30000/TCP   5m</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connect to the VirtualMachineInstance by using a node IP and node port
outside the cluster network:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ ssh cirros@$NODE_IP -p 30000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expose-virtualmachineinstance-as-a-loadbalancer-service"><a class="anchor" href="#expose-virtualmachineinstance-as-a-loadbalancer-service"></a>Expose VirtualMachineInstance as a LoadBalancer Service</h3>
<div class="paragraph">
<p>Expose the RDP port (3389) of a VirtualMachineInstance running on
KubeVirt by creating <code>LoadBalancer</code> service. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">v1</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Service</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">lbsvc</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">externalTrafficPolicy</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">Cluster</span></span>
  <span style="color:#606">ports</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">port: 27017</span></span>
    <span style="color:#606">protocol</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">TCP</span></span>
    <span style="color:#606">targetPort</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">3389</span></span>
  <span style="color:#606">selector</span>:
    <span style="color:#606">special</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key</span></span>
  <span style="color:#606">type</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">LoadBalancer</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could create this <code>LoadBalancer</code> service by using <code>kubectl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl -f lbsvc.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, the VirtualMachineInstance could be exposed using the
<code>virtctl</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ virtctl expose virtualmachineinstance vmi-ephemeral --name lbsvc --type LoadBalancer --port 27017 --target-port 3389</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the external IP of the service could be forced to a value
using the <code>--external-ip</code> flag (no validation is performed on this
value).</p>
</div>
<div class="paragraph">
<p>The service can be listed by querying for the service objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kubectl get svc
NAME      TYPE           CLUSTER-IP       EXTERNAL-IP                   PORT(S)           AGE
lbsvc     LoadBalancer   172.30.27.5      172.29.10.235,172.29.10.235   27017:31829/TCP   5s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>vinagre</code> client to connect your VirtualMachineInstance by using the
public IP and port.</p>
</div>
<div class="paragraph">
<p>Note that here the external port here (31829) was dynamically allocated.</p>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>
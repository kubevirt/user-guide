<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Using Virtual Machines | Memory over-commit</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://kubevirt.io/"><img alt="Kubevirt" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../using-virtual-machines/usage.html">Using Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        Memory over-commit
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-right"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse  list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-down"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse in list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class=" active" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Increasing the VirtualMachineInstance Density on Nodes</h2>
        </div>
        <div class="sect1">
<h2 id="increasing-the-virtualmachineinstance-density-on-nodes"><a class="anchor" href="#increasing-the-virtualmachineinstance-density-on-nodes"></a>Increasing the VirtualMachineInstance Density on Nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KubeVirt does not yet support classical Memory Overcommit Management or
Memory Ballooning. In other words VirtualMachineInstances can’t give
back memory they have allocated. However, a few other things can be
tweaked to reduce the memory footprint and overcommit the per-VMI memory
overhead.</p>
</div>
<div class="sect2">
<h3 id="remove-the-graphical-devices"><a class="anchor" href="#remove-the-graphical-devices"></a>Remove the Graphical Devices</h3>
<div class="paragraph">
<p>First the safest option to reduce the memory footprint, is removing the
graphical device from the VMI by setting
<code>spec.domain.devices.autottachGraphicsDevice</code> to <code>false</code>. See the video
and graphics device
<a href="/workloads/virtual-machines/virtualized-hardware-configuration#video-and-graphics-device">documentation</a>
for further details and examples.</p>
</div>
<div class="paragraph">
<p>This will save a constant amount of <code>16MB</code> per VirtualMachineInstance
but also disable VNC access.</p>
</div>
</div>
<div class="sect2">
<h3 id="overcommit-the-guest-overhead"><a class="anchor" href="#overcommit-the-guest-overhead"></a>Overcommit the Guest Overhead</h3>
<div class="paragraph">
<p>Before you continue, make sure you make yourself comfortable with the
<a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/">Out
of Resource Managment</a> of Kubernetes.</p>
</div>
<div class="paragraph">
<p>Every VirtualMachineInstance requests slightly more memory from
Kubernetes than what was requested by the user for the Operating System.
The additional memory is used for the per-VMI overhead consisting of our
infrastructure which is wrapping the actual VirtualMachineInstance
process.</p>
</div>
<div class="paragraph">
<p>In order to increase the VMI density on the node, it is possible to not
request the additional overhead by setting
<code>spec.domain.resources.overcommitGuestOverhead</code> to <code>true</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha2</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">testvmi-nocloud</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">terminationGracePeriodSeconds</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">30</span></span>
  <span style="color:#606">domain</span>:
    <span style="color:#606">resources</span>:
    <span style="color:#606">overcommitGuestOverhead</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span><span style="color:#D20">
      requests:
        memory: 1024M</span></span>
[<span style="color:#F00;background-color:#FAA">...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This will work fine for as long as most of the VirtualMachineInstances
will not request the whole memory. That is especially the case if you
have short-lived VMIs. But if you have long-lived
VirtualMachineInstances or do extremely memory intensive tasks inside
the VirtualMachineInstance, your VMIs will use all memory they are
granted sooner or later.</p>
</div>
</div>
<div class="sect2">
<h3 id="overcommit-guest-memory"><a class="anchor" href="#overcommit-guest-memory"></a>Overcommit Guest Memory</h3>
<div class="paragraph">
<p>The third option is real memory overcommit on the VMI. In this scenario
the VMI is explicitly told that it has more memory available than what
is requested from the cluster by setting <code>spec.domain.memory.guest</code> to a
value higher than <code>spec.domain.resources.requests.memory</code>.</p>
</div>
<div class="paragraph">
<p>The following definition requests <code>1024MB</code> from the cluster but tells
the VMI that it has <code>2048MB</code> of memory available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha2</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">testvmi-nocloud</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">terminationGracePeriodSeconds</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">30</span></span>
  <span style="color:#606">domain</span>:
    <span style="color:#606">resources</span>:
    <span style="color:#606">overcommitGuestOverhead</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span><span style="color:#D20">
      requests:
        memory: 1024M</span></span>
    <span style="color:#606">memory</span>:
      <span style="color:#606">guest</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2048M</span></span>
[<span style="color:#F00;background-color:#FAA">...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For as long as there is enough free memory available on the node, the
VMI can happily consume up to <code>2048MB</code>. This VMI will get the
<code>Burstable</code> resource class assigned by Kubernetes (See
<a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#create-a-pod-that-gets-assigned-a-qos-class-of-burstable">QoS
classes in Kubernetes</a> for more details). The same eviction rules like
for Pods apply to the VMI in case the node gets under memory pressure.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-memory-pressure-behaviour-of-nodes"><a class="anchor" href="#configuring-the-memory-pressure-behaviour-of-nodes"></a>Configuring the memory pressure behaviour of nodes</h3>
<div class="paragraph">
<p>If the node gets under memory pressure, depending on the <code>kubelet</code>
configuration the virtual machines may get killed by the OOM handler or
by the <code>kubelet</code> itself. It is possible to tweak that behaviour based on
the requirements of your VirtualMachineInstances by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configuring
<a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#soft-eviction-thresholds">Soft
Eviction Thresholds</a></p>
</li>
<li>
<p>Configuring
<a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#hard-eviction-thresholds">Hard
Eviction Thresholds</a></p>
</li>
<li>
<p>Requesting the right QoS class for VirtualMachineInstances</p>
</li>
<li>
<p>Setting <code>--system-reserved</code> and <code>--kubelet-reserved</code></p>
</li>
<li>
<p>Enabling KSM</p>
</li>
<li>
<p>Enabling swap</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="configuring-soft-eviction-thresholds"><a class="anchor" href="#configuring-soft-eviction-thresholds"></a>Configuring Soft Eviction Thresholds</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: Soft Eviction will effectively shutdown VirtualMachineInstances.
They are not paused, hibernated or migrated. Further, Soft Eviction is
disabled by default.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>If configured, VirtualMachineInstances get evicted once the available
memory falls below the threshold specified via <code>--eviction-soft</code> and the
VirtualmachineInstance is given the chance to perform a shutdown of the
VMI within a timespan specified via <code>--eviction-max-pod-grace-period</code>.
The flag <code>--eviction-soft-grace-period</code> specifies for how long a soft
eviction condition must be held before soft evictions are triggered.</p>
</div>
<div class="paragraph">
<p>If set properly according to the demands of the VMIs, overcommitting
should only lead to soft evictions in rare cases for some VMIs. They may
even get re-scheduled to the same node with less initial memory demand.
For some workload types, this can be perfectly fine and lead to better
overall memory-utilization.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuring-hard-eviction-thresholds"><a class="anchor" href="#configuring-hard-eviction-thresholds"></a>Configuring Hard Eviction Thresholds</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: If unspecified, the kubelet will do hard evictions for Pods once
<code>memory.available</code> falls below <code>100Mi</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Limits set via <code>--eviction-hard</code> will lead to immediate eviction of
VirtualMachineInstances or Pods. This stops VMIs without a grace period
and is comparable with power-loss on a real computer.</p>
</div>
<div class="paragraph">
<p>If the hard limit is hit, VMIs may from time to time simply be killed.
They may be re-scheduled to the same node immediately again, since they
start with less memory consumption again. This can be a simple option,
if the memory threshold is only very seldom hit and the work performed
by the VMIs is reproducible or it can be resumed from some checkpoints.</p>
</div>
</div>
<div class="sect3">
<h4 id="requesting-the-right-qos-class-for-virtualmachineinstances"><a class="anchor" href="#requesting-the-right-qos-class-for-virtualmachineinstances"></a>Requesting the right QoS Class for VirtualMachineInstances</h4>
<div class="paragraph">
<p>Different QoS classes get
<a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#static-policy">assigned
to Pods and VirtualMachineInstances</a> based on the <code>requests.memory</code> and
<code>limits.memory</code>. KubeVirt right now supports the QoS classes <code>Burstable</code>
and <code>Guaranteed</code>. <code>Burstable</code> VMIs are evicted before <code>Guaranteed</code> VMIs.</p>
</div>
<div class="paragraph">
<p>This allows creating two classes of VMIs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One type can have equal <code>requests.memory</code> and <code>limits.memory</code> set and
therefore gets the <code>Guaranteed</code> class assigned. This one will not get
evicted and should never run into memory issues, but is more demanding.</p>
</li>
<li>
<p>One type can have no <code>limits.memory</code> or a <code>limits.memory</code> which is
greater than <code>requests.memory</code> and therefore gets the <code>Burstable</code> class
assigned. These VMIs will be evicted first.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="setting-system-reserved-and-kubelet-reserved"><a class="anchor" href="#setting-system-reserved-and-kubelet-reserved"></a>Setting <code>--system-reserved</code> and <code>--kubelet-reserved</code></h4>
<div class="paragraph">
<p>It may be important to reserve some memory for other daemons (not
DaemonSets) which are running on the same node (e.g. ssh, dhcp servers,
…). The reservation can be done with the <code>--system-reserved</code> switch.
Further for the Kubelet and Docker a special flag called
<code>--kubelet-reserved</code> exists.</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling-ksm"><a class="anchor" href="#enabling-ksm"></a>Enabling KSM</h4>
<div class="paragraph">
<p>The <a href="https://www.linux-kvm.org/page/KSM">KSM</a> (Kernel same-page merging)
daemon can be started on the node. Depending on its tuning parameters it
can more or less aggressively try to merge identical pages between
applications and VirtualMachineInstances. The more aggressive it is
configured the more CPU it will use itself, so the memory overcommit
advantages comes with a slight CPU performance hit.</p>
</div>
<div class="paragraph">
<p>Config file tuning allows changes to scanning frequency (how often will
KSM activate) and aggressiveness (how many pages per second will it
scan).</p>
</div>
</div>
<div class="sect3">
<h4 id="enabling-swap"><a class="anchor" href="#enabling-swap"></a>Enabling Swap</h4>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note: This will definitely make sure that your VirtualMachines can’t
crash or get evicted from the node but it comes with the cost of pretty
unpredictable performance once the node runs out of memory and the
kubelet may not detect that it should evict Pods to increase the
performance again.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Enabling swap is in general
<a href="https://github.com/kubernetes/kubernetes/issues/53533">not recommended</a>
on Kubernetes right now. However, it can be useful in combination with
KSM, since KSM merges identical pages over time. Swap allows the VMIs to
successfuly allocate memory which will then effectively never be used
because of the later de-duplication done by KSM.</p>
</div>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Creating Virtual Machines | Interfaces and Networks</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://kubevirt.io/"><img alt="Kubevirt" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../creating-virtual-machines/intro.html">Creating Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        Interfaces and Networks
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
            <li><a class="" href="../administration/live-migration.html">Live Migration</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-down"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse in list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class=" active" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class="" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/virtio-win.html">virtio drivers for Microsoft Windows</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
            <li><a class="" href="../creating-virtual-machines/run-strategies.html">Run Strategies</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup7">
        <span id="tgSpan7" class="fa fa-angle-right"></span>Web Interface
      </a>
      <ul id="topicGroup7" class="collapse  list-unstyled">
            <li><a class="" href="../web-interface/web-interface.html">Web Interface</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>Interfaces and Networks</h2>
        </div>
        <div class="sect1">
<h2 id="interfaces-and-networks"><a class="anchor" href="#interfaces-and-networks"></a>Interfaces and Networks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Connecting a virtual machine to a network consists of two parts. First,
networks are specified in <code>spec.networks</code>. Then, interfaces backed by
the networks are added to the VM by specifying them in
<code>spec.domain.devices.interfaces</code>.</p>
</div>
<div class="paragraph">
<p>Each interface must have a corresponding network with the same name.</p>
</div>
<div class="paragraph">
<p>An <code>interface</code> defines a virtual network interface of a virtual machine
(also called a frontend). A <code>network</code> specifies the backend of an
<code>interface</code> and declares which logical or physical device it is
connected to (also called as backend).</p>
</div>
<div class="paragraph">
<p>There are multiple ways of configuring an <code>interface</code> as well as a
<code>network</code>.</p>
</div>
<div class="paragraph">
<p>All possible configuration options are available in the
<a href="https://kubevirt.io/api-reference/master/definitions.html#_v1_interface">Interface
API Reference</a> and
<a href="https://kubevirt.io/api-reference/master/definitions.html#_v1_network">Network
API Reference</a>.</p>
</div>
<div class="sect2">
<h3 id="backend"><a class="anchor" href="#backend"></a>Backend</h3>
<div class="paragraph">
<p>Network backends are configured in <code>spec.networks</code>. A network must have
a unique name. Additional fields declare which logical or physical
device the network relates to.</p>
</div>
<div class="paragraph">
<p>Each network should declare its type by defining one of the following
fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pod</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Kubernetes network</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>multus</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secondary network provided using Multus</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>genie</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secondary network provided using Genie</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="pod"><a class="anchor" href="#pod"></a>pod</h4>
<div class="paragraph">
<p>A <code>pod</code> network represents the default pod <code>eth0</code> interface configured
by cluster network solution that is present in each pod.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
          <span style="color:#606">masquerade</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
    <span style="color:#606">pod</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span> <span style="color:#777"># Stock pod network</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multus"><a class="anchor" href="#multus"></a>multus</h4>
<div class="paragraph">
<p>It is also possible to connect VMIs to secondary networks using
<a href="https://github.com/intel/multus-cni">Multus</a>. This assumes that multus is
installed across your cluster and a corresponding
<code>NetworkAttachmentDefinition</code> CRD was created.</p>
</div>
<div class="paragraph">
<p>The following example defines a network which uses the
<a href="https://github.com/kubevirt/ovs-cni">ovs-cni plugin</a>, which will connect
the VMI to Open vSwitch’s bridge <code>br1</code> and VLAN 100. Other CNI plugins
such as ptp, bridge, macvlan or Flannel might be used as well. For their
installation and usage refer to the respective project documentation.</p>
</div>
<div class="paragraph">
<p>First the <code>NetworkAttachmentDefinition</code> needs to be created. That is
usually done by an administrator. Users can then reference the
definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">k8s.cni.cncf.io/v1</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">NetworkAttachmentDefinition</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ovs-vlan-100</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">config</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'{</span><span style="color:#D20">
      &quot;cniVersion&quot;: &quot;0.3.1&quot;,
      &quot;type&quot;: &quot;ovs&quot;,
      &quot;bridge&quot;: &quot;br1&quot;,
      &quot;vlan&quot;: 100
    }'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With following definition, the VMI will be connected to the default pod
network and to the secondary Open vSwitch network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
          <span style="color:#606">masquerade</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
          <span style="color:#606">bootFileName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">default_image.bin</span></span>
          <span style="color:#606">tftpServerName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">tftp.example.com</span></span>
          <span style="color:#606">bootOrder</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">1</span></span>   <span style="color:#777"># attempt to boot from an external tftp server</span>
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: ovs-net</span></span>
          <span style="color:#606">bridge</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
          <span style="color:#606">bootOrder</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2</span></span>   <span style="color:#777"># if first attempt failed, try to PXE-boot from this L2 networks</span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
    <span style="color:#606">pod</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span> <span style="color:#777"># Stock pod network</span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: ovs-net</span></span>
    <span style="color:#606">multus</span>: <span style="color:#777"># Secondary multus network</span>
      <span style="color:#606">networkName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ovs-vlan-100</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to define a multus network as the default pod network with
<a href="https://github.com/intel/multus-cni">Multus</a>. A version of multus after this
<a href="https://github.com/intel/multus-cni/pull/174">Pull Request</a> is required
(currently master).</p>
</div>
<div class="paragraph">
<p><strong>Note the following:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>A multus default network and a pod network type are mutually exclusive.</p>
</li>
<li>
<p>The virt-launcher pod that starts the VMI will <strong>not</strong> have the pod network
configured.</p>
</li>
<li>
<p>The multus delegate chosen as default <strong>must</strong> return at least one IP address.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create a <code>NetworkAttachmentDefinition</code> with IPAM.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">k8s.cni.cncf.io/v1</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">NetworkAttachmentDefinition</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">macvlan-test</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">config</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'{</span><span style="color:#D20">
      &quot;type&quot;: &quot;macvlan&quot;,
      &quot;master&quot;: &quot;eth0&quot;,
      &quot;mode&quot;: &quot;bridge&quot;,
      &quot;ipam&quot;: {
        &quot;type&quot;: &quot;host-local&quot;,
              &quot;subnet&quot;: &quot;10.250.250.0/24&quot;
      }
    }'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Define a VMI with a <a href="https://github.com/intel/multus-cni">Multus</a> network as the default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: test1</span></span>
          <span style="color:#606">bridge</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: test1</span></span>
    <span style="color:#606">multus</span>: <span style="color:#777"># Multus network as default</span>
      <span style="color:#606">default</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
      <span style="color:#606">networkName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">macvlan-test</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="genie"><a class="anchor" href="#genie"></a>genie</h4>
<div class="paragraph">
<p>It is also possible to connect VMIs to multiple networks using
<a href="https://github.com/Huawei-PaaS/CNI-Genie">Genie</a>. This assumes that genie
is installed across your cluster.</p>
</div>
<div class="paragraph">
<p>The following example defines a network which uses
<a href="https://github.com/coreos/flannel-cni">Flannel</a> as the main network
provider and as the <a href="https://github.com/kubevirt/ovs-cni">ovs-cni plugin</a>
as the secondary one. The OVS CNI will connect the VMI to Open vSwitch’s
bridge <code>br1</code> and VLAN 100.</p>
</div>
<div class="paragraph">
<p>Other CNI plugins such as ptp, bridge, macvlan might be used as well.
For their installation and usage refer to the respective project
documentation.</p>
</div>
<div class="paragraph">
<p>Genie does not use the <code>NetworkAttachmentDefinition</code> CRD. Instead it
uses the name of the underlying CNI in order to find the required
configuration. It does that by looking into the configuration files
under <code>/etc/cni/net.d/</code> and finding the file that has that network name
as the CNI type. Therefore, for the case described above, the following
configuration file should exist, for example,
<code>/etc/cni/net.d/99-ovs-cni.conf</code> file would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span style="color:#606"><span style="color:#404">&quot;</span><span>cniVersion</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">0.3.1</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>type</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ovs</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>bridge</span><span style="color:#404">&quot;</span></span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">br1</span><span style="color:#710">&quot;</span></span>,
  <span style="color:#606"><span style="color:#404">&quot;</span><span>vlan</span><span style="color:#404">&quot;</span></span>: <span style="color:#00D">100</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly to Multus, Genie’s configuration file must be the first one in
the <code>/etc/cni/net.d/</code> directory. This also means that Genie cannot be
used together with Multus on the same cluster.</p>
</div>
<div class="paragraph">
<p>With following definition, the VMI will be connected to the default pod
network and to the secondary Open vSwitch network.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
          <span style="color:#606">bridge</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: ovs-net</span></span>
          <span style="color:#606">bridge</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
    <span style="color:#606">genie</span>: <span style="color:#777"># Stock pod network</span>
      <span style="color:#606">networkName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">flannel</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: ovs-net</span></span>
    <span style="color:#606">genie</span>: <span style="color:#777"># Secondary genie network</span>
      <span style="color:#606">networkName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ovs</span></span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="frontend"><a class="anchor" href="#frontend"></a>Frontend</h3>
<div class="paragraph">
<p>Network interfaces are configured in <code>spec.domain.devices.interfaces</code>.
They describe properties of virtual interfaces as ``seen'' inside guest
instances. The same network backend may be connected to a virtual
machine in multiple different ways, each with their own connectivity
guarantees and characteristics.</p>
</div>
<div class="paragraph">
<p>Each interface should declare its type by defining on of the following
fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bridge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connect using a linux bridge</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>slirp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connect using QEMU user networking mode</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sriov</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pass through a SR-IOV PCI device via <code>vfio</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>masquerade</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connect using Iptables rules to nat the traffic</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each interface may also have additional configuration fields that modify
properties ``seen'' inside guest instances, as listed below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>model</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One of: <code>e1000</code>, <code>e1000e</code>, <code>ne2k_pci</code>, <code>pcnet</code>, <code>rtl8139</code>,
<code>virtio</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>virtio</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NIC type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">macAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ff:ff:ff:ff:ff:ff</code> or <code>FF-FF-FF-FF-FF-FF</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MAC address
as seen inside the guest system, for example: <code>de:ad:00:00:be:af</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ports</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">empty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of ports to be forwarded to the virtual machine.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pciAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0000:81:00.1</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set network interface PCI address, for
example: <code>0000:81:00.1</code></p></td>
</tr>
</tbody>
</table>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
          <span style="color:#606">model</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">e1000</span></span> <span style="color:#777"># expose e1000 NIC to the guest</span>
          <span style="color:#606">masquerade</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span> <span style="color:#777"># connect through a masquerade</span>
          <span style="color:#606">ports</span>:
           - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: http</span></span>
             <span style="color:#606">port</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">80</span></span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: default</span></span>
    <span style="color:#606">pod</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span></code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> If a specific MAC address is configured for a virtual machine
interface, it&#8217;s passed to the underlying CNI plugin that is expected to
configure the backend to allow for this particular MAC address. Not every
plugin has native support for custom MAC addresses.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong>  For some CNI plugins without native support for custom MAC
addresses, there is a workaround, which is to use the <code>tuning</code> CNI plugin to
adjust pod interface MAC address. This can be used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">k8s.cni.cncf.io/v1</span><span style="color:#710">&quot;</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">NetworkAttachmentDefinition</span></span>
<span style="color:#606">metadata</span>:
  <span style="color:#606">name</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ptp-mac</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">config</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">'{</span><span style="color:#D20">
      &quot;cniVersion&quot;: &quot;0.3.1&quot;,
      &quot;name&quot;: &quot;ptp-mac&quot;,
      &quot;plugins&quot;: [
        {
          &quot;type&quot;: &quot;ptp&quot;,
          &quot;ipam&quot;: {
            &quot;type&quot;: &quot;host-local&quot;,
            &quot;subnet&quot;: &quot;10.1.1.0/24&quot;
          }
        },
        {
          &quot;type&quot;: &quot;tuning&quot;
        }
      ]
    }'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach may not work for all plugins. For example, OpenShift SDN is not
compatible with <code>tuning</code> plugin.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Plugins that handle custom MAC addresses natively: <code>ovs</code>.</p>
</li>
<li>
<p>Plugins that are compatible with <code>tuning</code> plugin: <code>flannel</code>, <code>ptp</code>, <code>bridge</code>.</p>
</li>
<li>
<p>Plugins that don&#8217;t need special MAC address treatment: <code>sriov</code> (in <code>vfio</code>
mode).</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="ports"><a class="anchor" href="#ports"></a>Ports</h4>
<div class="paragraph">
<p>Declare ports listen by the virtual machine</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> When using the slirp interface only the configured ports will be
forwarded to the virtual machine.</p>
</div>
</blockquote>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Format</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>port</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 - 65535</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port to expose</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>protocol</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TCP,UDP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">no</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection protocol</p></td>
</tr>
</tbody>
</table>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Tip:</strong> Use <code>e1000</code> model if your guest image doesn’t ship with virtio
drivers.</p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> Windows machines need the latest virtio network driver to configure
the correct MTU on the interface.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>If <code>spec.domain.devices.interfaces</code> is omitted, the virtual machine is
connected using the default pod network interface of <code>bridge</code> type. If
you’d like to have a virtual machine instance without any network
connectivity, you can use the <code>autoattachPodInterface</code> field as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">autoattachPodInterface</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">false</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="bridge"><a class="anchor" href="#bridge"></a>bridge</h4>
<div class="paragraph">
<p>In <code>bridge</code> mode, virtual machines are connected to the network backend
through a linux ``bridge''. The pod network IPv4 address is delegated to
the virtual machine via DHCPv4. The virtual machine should be configured
to use DHCP to acquire IPv4 addresses.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> If a specific MAC address is not configured in the virtual machine
interface spec the MAC address from the relevant pod interface is delegated to
the virtual machine.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VM</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">devices</span>:
      <span style="color:#606">interfaces</span>:
        - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: red</span></span>
          <span style="color:#606">bridge</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">{}</span></span> <span style="color:#777"># connect through a bridge</span>
  <span style="color:#606">networks</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">name: red</span></span>
    <span style="color:#606">multus</span>:
      <span style="color:#606">networkName</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">red</span></span>
<span style="color:#f8f;background:#505"><span style="color:#f4f">---</span></span><span style="color:#F00;background-color:#FAA">--</span>

<span style="color:#F00;background-color:#FAA">At this time, `bridge` mode doesn’t support additional configuration</span>
<span style="color:#F00;background-color:#FAA">fields.</span>

<span style="color:#F00;background-color:#FAA">______________________________________________________________________________</span>
<span style="color:#d70">*Note</span><span style="color:#F00;background-color:#FAA">:</span><span style="color:#F00;background-color:#FAA">* due to IPv4 address delagation, in `bridge` mode the pod doesn’t have</span>
<span style="color:#F00;background-color:#FAA">an IP address configured, which may introduce issues with third-party solutions</span>
<span style="color:#F00;background-color:#FAA">that may rely on it. For example, Istio may not work in this mode.</span>
<span style="color:#F00;background-color:#FAA">______________________________________________________________________________</span>

<span style="color:#F00;background-color:#FAA">slirp</span>
<span style="color:#F00;background-color:#FAA">^^^^^</span>

<span style="color:#F00;background-color:#FAA">In `slirp` mode, virtual machines are connected to the network backend</span>
<span style="color:#F00;background-color:#FAA">using QEMU user networking mode. In this mode, QEMU allocates internal</span>
<span style="color:#F00;background-color:#FAA">IP addresses to virtual machines and hides them behind NAT.</span>

[<span style="color:#F00;background-color:#FAA">source,yaml]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>kind: VM
spec:
  domain:
    devices:
      interfaces:
        - name: red
          slirp: {} # connect using SLIRP mode
  networks:
  - name: red
    pod: {}</p>
</div>
<div class="listingblock">
<div class="content">
<pre>At this time, `slirp` mode doesn’t support additional configuration
fields.

______________________________________________________________________________
*Note:* in `slirp` mode, the only supported protocols are TCP and UDP. ICMP is
_not_ supported.
______________________________________________________________________________

More information about SLIRP mode can be found in
https://wiki.qemu.org/Documentation/Networking#User_Networking_.28SLIRP.29[QEMU
Wiki].

masquerade
^^^^^^^^^^

In `masquerade` mode, KubeVirt allocates internal
IP addresses to virtual machines and hides them behind NAT.
All the traffic exiting virtual machines is "NAT'ed" using pod IP addresses.
A virtual machine should be configured to use DHCP to acquire IPv4 addresses.

To allow traffic into virtual machines, the template `ports` section of the
interface should be configured as follows.

[source,yaml]</pre>
</div>
</div>
<div class="paragraph">
<p>kind: VM
spec:
  domain:
    devices:
      interfaces:
        - name: red
          masquerade: {} # connect using masquerade mode
          ports:
            - port: 80 # allow incoming traffic on port 80 to get into the virtual machine
  networks:
  - name: red
    pod: {}</p>
</div>
<div class="listingblock">
<div class="content">
<pre>______________________________________________________________________________
*Note:* Masquerade is only allowed to connect to the pod network.
*Note:* The network CIDR can be configured in the pod network section using the
`vmNetworkCIDR` attribute.
______________________________________________________________________________

virtio-net multiqueue
^^^^^^^^^^^^^^^^^^^^^

Setting the `networkInterfaceMultiqueue` to `true` will enable the
multi-queue functionality, increasing the number of vhost queue, for
interfaces configured with a `virtio` model.

[source,yaml]</pre>
</div>
</div>
<div class="paragraph">
<p>kind: VM
spec:
  domain:
    devices:
      networkInterfaceMultiqueue: true</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Users of a Virtual Machine with multiple vCPUs may benefit of increased
network throughput and performance.

Currently, the number of queues is being determined by the number of
vCPUs of a VM. This is because multi-queue support optimizes RX
interrupt affinity and TX queue selection in order to make a specific
queue private to a specific vCPU.

Without enabling the feature, network performance does not scale as the
number of vCPUs increases. Guests cannot transmit or retrieve packets in
parallel, as virtio-net has only one TX and RX queue.

_NOTE_: Although the virtio-net multiqueue feature provides a
performance benefit, it has some limitations and therefore should not be
unconditionally enabled

Some known limitations
++++++++++++++++++++++

* Guest OS is limited to ~200 MSI vectors. Each NIC queue requires a MSI
vector, as well as any virtio device or assigned PCI device. Defining an
instance with multiple virtio NICs and vCPUs might lead to a possibility
of hitting the guest MSI limit.
* virtio-net multiqueue works well for incoming traffic, but can
occasionally cause a performance degradation, for outgoing traffic.
Specifically, this may occur when sending packets under 1,500 bytes over
the Transmission Control Protocol (TCP) stream.
* Enabling virtio-net multiqueue increases the total network throughput,
but in parallel it also increases the CPU consumption.
* Enabling virtio-net multiqueue in the host QEMU config, does not
enable the functionality in the guest OS. The guest OS administrator
needs to manually turn it on for each guest NIC that requires this
feature, using ethtool.
* MSI vectors would still be consumed (wasted), if multiqueue was
enabled in the host, but has not been enabled in the guest OS by the
administrator.
* In case the number of vNICs in a guest instance is proportional to the
number of vCPUs, enabling the multiqueue feature is less important.
* Each virtio-net queue consumes 64 KB of kernel memory for the vhost
driver.

_NOTE_: Virtio-net multiqueue should be enabled in the guest OS
manually, using ethtool. For example:
`ethtool -L &lt;NIC&gt; combined #num_of_queues`

More information please refer to
http://www.linux-kvm.org/page/Multiqueue[KVM/QEMU MultiQueue].

sriov
^^^^^

In `sriov` mode, virtual machines are directly exposed to an SR-IOV PCI device,
usually allocated by https://github.com/intel/sriov-network-device-plugin[Intel
SR-IOV device plugin]. The device is passed through into the guest operating
system as a host device, using the
https://www.kernel.org/doc/Documentation/vfio.txt[vfio] userspace interface, to
maintain high networking performance.

[source,yaml]</pre>
</div>
</div>
<div class="paragraph">
<p>kind: VM
spec:
  domain:
    devices:
      interfaces:
        - name: sriov-net
          sriov: {}
  networks:
  - name: sriov-net
    multus:
      networkName: sriov-net-crd</p>
</div>
<div class="listingblock">
<div class="content">
<pre>To simplify procedure, please use
https://github.com/openshift/sriov-network-operator[OpenShift SR-IOV operator]
to deploy and configure SR-IOV components in your cluster. On how to use the
operator, please refer to
https://github.com/openshift/sriov-network-operator/blob/master/doc/quickstart.md[their
respective documentation].

______________________________________________________________________________
*Note:* KubeVirt relies on VFIO userspace driver to pass PCI devices into VMI
guest. Because of that, when configuring SR-IOV operator policies, make sure
you define a pool of VF resources that uses `driver: vfio`.
______________________________________________________________________________</pre>
</div>
</div>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>KubeVirt Latest | Creating Virtual Machines | Guaranteed CPU usage</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <link href="../../latest/_stylesheets/asciibinder.css" rel="stylesheet" />

   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
   <!--[if lt IE 9]>
     <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
     <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
   <![endif]-->

  <link href="../../latest/_images/favicon32x32.png" rel="shortcut icon" type="text/css">
  <!--[if IE]><link rel="shortcut icon" href="../../latest/_images/favicon.ico"><![endif]-->
  <meta content="AsciiBinder" name="application-name">
</head>
<body>
  <div class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="https://kubevirt.io/"><img alt="Kubevirt" height="64px" src="../../latest/_images/KubeVirt_icon.png"></a>
      </div>
    </div>
  </div>
  <div class="container">
    <p class="toggle-nav visible-xs pull-left">
      <button class="btn btn-default btn-sm" type="button" data-toggle="offcanvas">Toggle nav</button>
    </p>
    <ol class="breadcrumb">
      <li class="sitename">
        <a href="../../index.html">Documentation</a>
      </li>
      <li class="hidden-xs active">
        <a href="../welcome/index.html">KubeVirt Latest</a>
      </li>
      <li class="hidden-xs active">
        <a href="../creating-virtual-machines/intro.html">Creating Virtual Machines</a>
      </li>
      
      <li class="hidden-xs active">
        Guaranteed CPU usage
      </li>
    </ol>
    <div class="row row-offcanvas row-offcanvas-left">
      <div class="col-xs-8 col-sm-3 col-md-3 sidebar sidebar-offcanvas">
        <ul class="nav nav-sidebar">
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup0">
        <span id="tgSpan0" class="fa fa-angle-right"></span>Welcome
      </a>
      <ul id="topicGroup0" class="collapse  list-unstyled">
            <li><a class="" href="../welcome/index.html">Welcome</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup1">
        <span id="tgSpan1" class="fa fa-angle-right"></span>Release Notes
      </a>
      <ul id="topicGroup1" class="collapse  list-unstyled">
            <li><a class="" href="../release-notes/changelog.html">Changelog</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup2">
        <span id="tgSpan2" class="fa fa-angle-right"></span>Architecture
      </a>
      <ul id="topicGroup2" class="collapse  list-unstyled">
            <li><a class="" href="../architecture/virtual-machine.html">Virtual Machines</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup3">
        <span id="tgSpan3" class="fa fa-angle-right"></span>Installation & Administration
      </a>
      <ul id="topicGroup3" class="collapse  list-unstyled">
            <li><a class="" href="../administration/intro.html">Installation</a></li>
            <li><a class="" href="../administration/api-validation.html">Webhooks</a></li>
            <li><a class="" href="../administration/authorization.html">Authorization</a></li>
            <li><a class="" href="../administration/monitoring.html">Monitoring</a></li>
            <li><a class="" href="../administration/annotations_and_labels.html">Annotations and Labels</a></li>
            <li><a class="" href="../administration/unresponsive-nodes.html">Unresponsive node handling</a></li>
            <li><a class="" href="../administration/node-eviction.html">Node eviciton</a></li>
            <li><a class="" href="../administration/image-upload.html">Image upload</a></li>
            <li><a class="" href="../administration/live-migration.html">Live Migration</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup4">
        <span id="tgSpan4" class="fa fa-angle-down"></span>Creating Virtual Machines
      </a>
      <ul id="topicGroup4" class="collapse in list-unstyled">
            <li><a class="" href="../creating-virtual-machines/intro.html">Introduction</a></li>
            <li><a class="" href="../creating-virtual-machines/virtualized-hardware-configuration.html">Devices</a></li>
            <li><a class="" href="../creating-virtual-machines/disks-and-volumes.html">Disks and Volumes</a></li>
            <li><a class="" href="../creating-virtual-machines/interfaces-and-networks.html">Interfaces and Networks</a></li>
            <li><a class=" active" href="../creating-virtual-machines/dedicated-cpu.html">Guaranteed CPU usage</a></li>
            <li><a class="" href="../creating-virtual-machines/startup-scripts.html">cloud-init</a></li>
            <li><a class="" href="../creating-virtual-machines/guest-operating-system-information.html">Associating Guest Informations</a></li>
            <li><a class="" href="../creating-virtual-machines/virtio-win.html">virtio drivers for Microsoft Windows</a></li>
            <li><a class="" href="../creating-virtual-machines/presets.html">Presets</a></li>
            <li><a class="" href="../creating-virtual-machines/probes.html">Probes</a></li>
            <li><a class="" href="../creating-virtual-machines/run-strategies.html">Run Strategies</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup5">
        <span id="tgSpan5" class="fa fa-angle-right"></span>Using Virtual Machines
      </a>
      <ul id="topicGroup5" class="collapse  list-unstyled">
            <li><a class="" href="../using-virtual-machines/usage.html">Usage</a></li>
            <li><a class="" href="../using-virtual-machines/life-cycle.html">Starting and Stopping</a></li>
            <li><a class="" href="../using-virtual-machines/graphical-and-console-access.html">Console Access (Serial and Graphical)</a></li>
            <li><a class="" href="../using-virtual-machines/assigning-vms-to-nodes.html">Node placement</a></li>
            <li><a class="" href="../using-virtual-machines/dns.html">DNS Integration</a></li>
            <li><a class="" href="../using-virtual-machines/expose-service.html">Service Integration</a></li>
            <li><a class="" href="../using-virtual-machines/create-networkpolicy.html">Assigning Network Policies</a></li>
            <li><a class="" href="../using-virtual-machines/overcommit.html">Memory over-commit</a></li>
            <li><a class="" href="../using-virtual-machines/virtual-machine-replica-set.html">Virtual Machine Replica Set</a></li>
            <li><a class="" href="../using-virtual-machines/vmctl.html">vmctl</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup6">
        <span id="tgSpan6" class="fa fa-angle-right"></span>Working with Templates
      </a>
      <ul id="topicGroup6" class="collapse  list-unstyled">
            <li><a class="" href="../templates/common-templates.html">Introduction</a></li>
            <li><a class="" href="../templates/using-templates.html">Using templates</a></li>
      </ul>
    </li>
    <li class="nav-header">
      <a class="" href="#" data-toggle="collapse" data-target="#topicGroup7">
        <span id="tgSpan7" class="fa fa-angle-right"></span>Web Interface
      </a>
      <ul id="topicGroup7" class="collapse  list-unstyled">
            <li><a class="" href="../web-interface/web-interface.html">Web Interface</a></li>
      </ul>
    </li>
</ul>
      </div>
      <div class="col-xs-12 col-sm-9 col-md-9 main">
        <div class="page-header">
          <h2>VirtualMachineInstance with dedicated CPU resources</h2>
        </div>
        <div class="sect1">
<h2 id="virtualmachineinstance-with-dedicated-cpu-resources"><a class="anchor" href="#virtualmachineinstance-with-dedicated-cpu-resources"></a>VirtualMachineInstance with dedicated CPU resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Certain workloads, requiring a predictable latency and enhanced
performance during its execution would benefit from obtaining dedicated
CPU resources. KubeVirt, relying on the Kubernetes CPU manager, is able
to pin guest’s vCPUs to the host’s pCPUs.</p>
</div>
<div class="paragraph">
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/">Kubernetes
CPU manager</a>
<sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub><sub>~</sub>~</p>
</div>
<div class="paragraph">
<p>Kubernetes CPU manager is a mechanism that affects the scheduling of
workloads, placing it on a host which can allocate <code>Guaranteed</code>
resources and pin certain POD’s containers to host pCPUs, if the
following requirement are met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/#create-a-pod-that-gets-assigned-a-qos-class-of-guaranteed">POD’s
QOS</a> is Guaranteed</p>
<div class="ulist">
<ul>
<li>
<p>resources requests and limits are equal</p>
</li>
<li>
<p>all containers in the POD express CPU and memory requirements</p>
</li>
</ul>
</div>
</li>
<li>
<p>Requested number of CPUs is an Integer</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additional information: *
<a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/">Enabling
the CPU manager on Kubernetes</a> *
<a href="https://docs.openshift.com/container-platform/3.10/scaling_performance/using_cpu_manager.html">Enabling
the CPU manager on OKD</a> *
<a href="https://kubernetes.io/blog/2018/07/24/feature-highlight-cpu-manager/">Kubernetes
blog explaning the feature</a></p>
</div>
<div class="sect2">
<h3 id="requesting-dedicated-cpu-resources"><a class="anchor" href="#requesting-dedicated-cpu-resources"></a>Requesting dedicated CPU resources</h3>
<div class="paragraph">
<p>Setting <code>spec.domain.cpu.dedicatedCpuPlacement</code> to <code>true</code> in a VMI spec
will indicate the desire to allocate dedicated CPU resource to the VMI</p>
</div>
<div class="paragraph">
<p>Kubevirt will verify that all the necessary conditions are met, for the
Kubernetes CPU manager to pin the virt-launcher container to dedicated
host CPUs. Once, virt-launcher is running, the VMI’s vCPUs will be
pinned to the pCPUS that has been dedicated for the virt-launcher
container.</p>
</div>
<div class="paragraph">
<p>Expressing the desired amount of VMI’s vCPUs can be done by either
setting the guest topology in <code>spec.domain.cpu</code> (<code>sockets</code>, <code>cores</code>, <code>threads</code>)
or <code>spec.domain.resources.[requests/limits].cpu</code> to a whole number, integer (e.g. 1,
2, etc) indicating the number of vCPUs requested for the VMI. Number of vCPUs is counted
as <code>sockets * cores * threads</code> or if <code>spec.domain.cpu</code> is empty then it takes value from
<code>spec.domain.resources.requests.cpu</code> or <code>spec.domain.resources.limits.cpu</code>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Note:</strong> Users should not specify both <code>spec.domain.cpu</code> and
<code>spec.domain.resources.[requests/limits].cpu</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> <code>spec.domain.resources.requests.cpu</code> must be equal to
<code>spec.domain.resources.limits.cpu</code></p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> Multiple cpu-bound microbenchmarks show a significant performance advantage when
using <code>spec.domain.cpu.sockets</code> instead of <code>spec.domain.cpu.cores</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>All inconsistent requirements will be rejected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha3</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">cpu</span>:
      <span style="color:#606">sockets</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2</span></span>
      <span style="color:#606">cores</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">1</span></span>
      <span style="color:#606">threads</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">1</span></span>
      <span style="color:#606">dedicatedCpuPlacement</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
    <span style="color:#606">resources</span>:
      <span style="color:#606">limits</span>:
        <span style="color:#606">memory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2Gi</span></span>
[<span style="color:#F00;background-color:#FAA">...]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>OR</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha3</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">cpu</span>:
      <span style="color:#606">dedicatedCpuPlacement</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
    <span style="color:#606">resources</span>:
      <span style="color:#606">limits</span>:
        <span style="color:#606">cpu</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2</span></span>
        <span style="color:#606">memory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2Gi</span></span>
[<span style="color:#F00;background-color:#FAA">...]</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="requesting-dedicated-cpu-for-qemu-emulator"><a class="anchor" href="#requesting-dedicated-cpu-for-qemu-emulator"></a>Requesting dedicated CPU for QEMU emulator</h3>
<div class="paragraph">
<p>A number of QEMU threads, such as QEMU main event loop, async I/O operation completion, etc., also execute on the same physical CPUs as the VMI&#8217;s vCPUs. This may affect the expected latency of a vCPU.
In order to enhance the real-time support in KubeVirt and provide improved latency, KubeVirt will allocate an additional dedicated CPU, exclusively for the emulator thread, to which it will be pinned. This will effectively "isolate" the emulator thread from the vCPUs of the VMI.</p>
</div>
<div class="paragraph">
<p>This functionality can be enabled by specifying <code>isolateEmulatorThread: true</code> inside VMI spec&#8217;s <code>Spec.Domain.CPU</code> section.
Naturally, this setting has to be specified in a combination with a <code>dedicatedCpuPlacement: true</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apiVersion</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">kubevirt.io/v1alpha3</span></span>
<span style="color:#606">kind</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">VirtualMachineInstance</span></span>
<span style="color:#606">spec</span>:
  <span style="color:#606">domain</span>:
    <span style="color:#606">cpu</span>:
      <span style="color:#606">dedicatedCpuPlacement</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
      <span style="color:#606">isolateEmulatorThread</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">true</span></span>
    <span style="color:#606">resources</span>:
      <span style="color:#606">limits</span>:
        <span style="color:#606">cpu</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2</span></span>
        <span style="color:#606">memory</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">2Gi</span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="identifying-nodes-with-a-running-cpu-manager"><a class="anchor" href="#identifying-nodes-with-a-running-cpu-manager"></a>Identifying nodes with a running CPU manager</h3>
<div class="paragraph">
<p>At this time,
<a href="https://github.com/kubernetes/kubernetes/issues/66525">Kubernetes doesn’t
label the nodes</a> that has CPU manager running on it.</p>
</div>
<div class="paragraph">
<p>KubeVirt has a mechansim to identify which nodes has the CPU manager
running and manually add a <code>cpumanager=true</code> label. This label will be
removed when KubeVirt will identify that CPU manager is no longer
running on the node. This automatic identification should be viewed as a
temporary workaround until Kubernetes will provide the required
functionality. Therefore, this feature should be manually enabled by
adding CPUManager to the kube-config feature-gate field.</p>
</div>
<div class="paragraph">
<p>When automatic identification is disabled, cluster administrator may
manually add the above label to all the nodes when CPU Manager is
running.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Nodes’ labels are view-able: <code>kubectl describe nodes</code></p>
</li>
<li>
<p>Administrators may manually label a missing node:
<code>kubectl label node [node_name] cpumanager=true</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="enabling-the-cpu-manager-automatic-identification-feature-gate"><a class="anchor" href="#enabling-the-cpu-manager-automatic-identification-feature-gate"></a>Enabling the CPU Manager automatic identification feature gate</h4>
<div class="paragraph">
<p>To enable the automatic idetification, user may expand the
<code>feature-gates</code> field in the kubevirt-config config map by adding the
<code>CPUManager</code> to it.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>apiVersion: v1
kind: ConfigMap
metadata:
  name: kubevirt-config
  namespace: kubevirt
  labels:
    kubevirt.io: ""
data:
  feature-gates: "CPUManager"</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, users can edit an existing kubevirt-config:</p>
</div>
<div class="paragraph">
<p><code>kubectl edit configmap kubevirt-config -n kubevirt</code></p>
</div>
<div class="literalblock">
<div class="content">
<pre>...
data:
  feature-gates: "DataVolumes,CPUManager"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sidecar-containers-and-cpu-allocation-overhead"><a class="anchor" href="#sidecar-containers-and-cpu-allocation-overhead"></a>Sidecar containers and CPU allocation overhead</h3>
<div class="paragraph">
<p><strong>Note:</strong> In order to run sidecar containers, KubeVirt requires the <code>Sidecar</code> feature gate to be enabled by adding <code>Sidecar</code>
to the <code>kubevirt-config</code> ConfigMap&#8217;s <code>feature-gates</code> field.</p>
</div>
<div class="paragraph">
<p>According to the Kubernetes CPU manager model, in order the POD would
reach the required QOS level <code>Guaranteed</code>, all containers in the POD
must express CPU and memory requirements. At this time, Kubevirt often
uses a sidecar container to mount VMI’s registry disk. It also uses a
sidecar container of it’s hooking mechanism. These additional resources
can be viewed as an overhead and should be taken into account when
calculating a node capacity. &gt; <strong>Note:</strong> The current defaults for
sidecar’s resources: &gt; * CPU: 200m &gt; * Memory: 64M &gt; As the CPU resource
is not expressed as a whole number, CPU manager will not &gt; attempt to
pin the sidecar container to a host CPU.</p>
</div>
</div>
</div>
</div>
      </div>
    </div>
  </div>
   <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
   <!-- Latest compiled and minified JavaScript -->
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
   <script src="../../latest/_javascripts/bootstrap-offcanvas.js" type="text/javascript"></script>
   <script type="text/javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      $("[id^='topicGroup']").on('show.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicGroup']").on('hide.bs.collapse', function (event) {
        if (!($(event.target).attr('id').match(/^topicSubGroup/))) {
          $(this).parent().find("[id^='tgSpan']").toggleClass("fa-angle-right fa-angle-down");
        }
      });
      $("[id^='topicSubGroup']").on('show.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
      $("[id^='topicSubGroup']").on('hide.bs.collapse', function () {
        $(this).parent().find("[id^='sgSpan']").toggleClass("fa-caret-right fa-caret-down");
      });
    });
    /*]]>*/
  </script>
</body>
</html>